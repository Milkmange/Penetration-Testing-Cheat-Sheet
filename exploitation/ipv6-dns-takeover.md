# IPv6 DNS Takeover to Domain Admin using mitm6 and ntlmrelayx

## Background

Microsoft Windows hosts will default to resolving all DNS lookups over IPv6, if an IPv6 DNS server broadcasts and is known on the network. The tool mitm6 can be used to create a rogue IPv6 DNS server that will assume the role of answering DNS requests within the active directory network. Once DNS requests are man-in-the-middled, ntlmrelayx can be used to relay authentication requests to a domain controller over LDAPS and carry out two objectives. The first is that all user accounts, groups, trusts and domain information will be dumped into HTML and json files for parsing. If a DNS request for an administrator is intercepted, a new admin user will be created with rights that will allow a dcsync attack to be conducted against the domain controller.

This attack is incredibly effective on large enterprise networks and has assisted in getting domain admin with no prior user credentials available.

## Steps to carry out the attack

For this attack to work, you will need to be situated on an internal network segment of the active directory domain with a Linux distribution such as Kali Linux. You **do not** need any credentials for this attack to be effective.

First start man-in-the-middle 6 (mitm6) available here "https://github.com/dirkjanm/mitm6" and specify the name of the active directory domain you are attacking, which in this example is `domain.local`:

```shell
mitm6 -d domain.local
```

Now impacket's ntlmrelayx.py "https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py" can be used to relay authentication requests to the domain controller, once an IPv6 DNS request is received:

```shell
ntlmrelayx.py -6 -t ldaps://<IP-Address-of-domain-controller> -wh fakewpad.domain.local -l loot-directory
```
Once a valid authentication request is received from a standard user within the domain, the `loot-directory` will be populated with both HTML and json files that contain all details about the domain, including users, groups, domain trusts etc.

If an administrator logs into the domain, the authentication request is relayed to the domain controller over LDAPS and ntlmrelayx will create a user that has rights to perform a dcsync attack against the domain controller.

Note that on a large domain that the username and password of the created user can easily be missed due to only outputting the details to STD OUT and not storing them into a file.

Id recommend running the ntlmrelayx command and `| tee log.txt` to store a full log of the output. In a seperate console, I'd then run `tail -f log.txt | grep -Eai "new user"`. This will instantly notify you that a new user has been created and that the attack can now be stopped.
